# 接口与前端试用阶段性报告

## 概述
- 目标：打通火山引擎单向流式 TTS（WebSocket V3）到本地前端试用页面的完整链路，并实现“边合成边播放”的体验。
- 产出：本地 Node 代理新增两个接口（批量/流式），前端试用页支持选择流式或非流式播放，完成端到端验证。
- 当前部署：本地服务运行在 http://localhost:8088/ ，服务端代码位于“流式语音识别 api 接口及测试/前端测试”目录。

## 接口实现
- 非流式合成播放接口
  - 路径：POST /api/tts
  - 行为：服务端通过上游 WebSocket 持续接收音频分片，但在本地累计完整音频后一次性返回（Blob），前端拿到完整数据后播放。
  - 代码参考：server.js 中 /api/tts 路由实现  
    - [server.js:API /api/tts](file:///Users/lishuyi/Downloads/TRAE%20-%20%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%80%E5%8F%91%E7%BB%BC%E5%90%88/Project_Maia/%E6%B5%81%E5%BC%8F%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%20api%20%E6%8E%A5%E5%8F%A3%E5%8F%8A%E6%B5%8B%E8%AF%95/%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95/server.js#L31-L309)
- 流式合成播放接口
  - 路径：GET /api/tts/stream?speaker=...&format=mp3&text=...
  - 行为：服务端直连上游 WebSocket，收到音频分片即通过 HTTP 分块写入（`res.write`）回传给浏览器，浏览器 `<audio>` 指向该 URL 即可边下边播。
  - 格式：建议 mp3（已在前端强制将流式播放格式固定为 mp3，以确保浏览器稳定播放）。
  - 代码参考：server.js 中 /api/tts/stream 路由实现  
    - [server.js:API /api/tts/stream](file:///Users/lishuyi/Downloads/TRAE%20-%20%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%80%E5%8F%91%E7%BB%BC%E5%90%88/Project_Maia/%E6%B5%81%E5%BC%8F%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%20api%20%E6%8E%A5%E5%8F%A3%E5%8F%8A%E6%B5%8B%E8%AF%95/%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95/server.js#L31-L170)

## 上游连接与鉴权
- 上游端点：wss://openspeech.bytedance.com/api/v3/tts/unidirectional/stream
- 主要头信息：
  - X-Api-App-Key：应用 APP ID
  - X-Api-Access-Key：Access Token
  - X-Api-Resource-Id：资源 ID（当前使用 seed-tts-2.0）
  - X-Api-Connect-Id：随机会话 ID
- 安全措施：密钥仅在后端代理中注入，前端不暴露任何鉴权信息（遵循前后端隔离的安全实践）。

## 前端试用
- 页面路径：/tts.html
- 能力：
  - 选择 speaker、format
  - 切换“流式播放（建议 mp3）”开关
  - 合成并播放、停止
- 代码参考：
  - 页面结构：[tts.html](file:///Users/lishuyi/Downloads/TRAE%20-%20%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%80%E5%8F%91%E7%BB%BC%E5%90%88/Project_Maia/%E6%B5%81%E5%BC%8F%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%20api%20%E6%8E%A5%E5%8F%A3%E5%8F%8A%E6%B5%8B%E8%AF%95/%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95/tts.html#L16-L49)
  - 前端逻辑（流式/非流式切换）：[tts.js](file:///Users/lishuyi/Downloads/TRAE%20-%20%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%80%E5%8F%91%E7%BB%BC%E5%90%88/Project_Maia/%E6%B5%81%E5%BC%8F%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%20api%20%E6%8E%A5%E5%8F%A3%E5%8F%8A%E6%B5%8B%E8%AF%95/%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95/tts.js#L41-L108)

## 验证与结果
- 非流式接口回归
  - 命令：`POST /api/tts`，返回 mp3 Blob
  - 结果：音频文件有效（ID3 v2.4，MP3，24kHz，单声道），大小约 24KB（示例文本）。
- 流式接口验证
  - 命令：`GET /api/tts/stream?...`，HTTP 分块传输，`X-Accel-Buffering: no`
  - 结果：音频按分片推送，浏览器 `<audio>` 可即时播放，示例文本输出约 20KB。
- 稳定性：接口具备基本错误处理（上游失败/超时），对前端返回明确错误信息；正常链路下可持续播放到结束事件。

## 现状与结论
- 已实现：
  - 单向流式 WebSocket 上游打通
  - 本地代理的非流式与流式两种 HTTP 接口
  - 前端试用页面支持切换播放模式
  - 基本稳定性与回归验证
- 结论：当前方案满足“边合成边播放”的体验要求，并保留非流式模式以兼顾兼容性与简单性。

## 后续优化建议
- 体验优化
  - 更激进的分片推送与缓冲策略，以进一步缩短“起播延迟”
  - 文本过长场景的分段合成与拼接，避免一次会话过长
- 异常与观测
  - 增加日志聚合与失败重试策略（例如上游网络抖动时自动重连）
  - 在前端显示合成耗时、首帧时间等指标
- 可维护性
  - 抽象公共的上游协议解析模块，减少重复代码
  - 增加简单的集成测试脚本（对两种接口做自动化回归）

## 使用说明
- 启动
  - 环境变量：`PORT=8088`，`TTS_CREDS_FILE=.../服务接口认证信息 key token.md`，`TTS_RESOURCE_ID=seed-tts-2.0`
  - 启动命令（已在会话中运行）：`node server.js`
- 试用
  - 浏览器访问 `http://localhost:8088/tts.html`
  - 勾选“流式播放（建议 mp3）”体验边下边播，不勾选则使用非流式一次性播放

