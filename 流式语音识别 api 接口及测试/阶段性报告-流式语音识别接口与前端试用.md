# 阶段性报告：流式语音识别接口与前端试用（已跑通）

## 1. 目标与范围

### 目标
- 验证“录音文件识别（HTTP 提交/查询）”接口可跑通
- 基于现有示例代码，产出“用户可直接试用”的实时麦克风流式识别前端
  - 点击“开始说话”实时出字
  - 点击“结束说话”输出完整文本

### 范围
- 覆盖两类能力：
  - 录音文件识别（AUC）：HTTP 提交任务 + 轮询查询结果
  - 流式语音识别（SAUC）：WebSocket 二进制协议，麦克风实时 PCM 分包上传

## 2. 输入资料
- 示例代码目录：`示例代码/`
  - `流式语音识别示例代码 01.md`（submit）
  - `流式语音识别示例代码 02.md`（query）
- 开发者文档：
  - https://www.volcengine.com/docs/6561/1354869?lang=zh （大模型流式语音识别 WebSocket）
  - https://www.volcengine.com/docs/6561/80818?lang=zh （录音文件识别）

## 3. 过程回顾（关键步骤）

### 3.1 接口连通性验证（AUC：submit + query）
- 使用示例 `submit` 接口提交公网音频 URL
- 使用示例 `query` 接口查询识别结果
- 结果：接口调用成功、返回识别文本，证明 AUC 任务型识别流程可用

### 3.2 前端试用方案选型（从“离线 URL”升级到“实时麦克风流式”）
- 初版前端支持：输入音频 URL → 提交 → 轮询查询 → 输出文本（适合验证 AUC）
- 目标要求升级为：点击按钮直接说话、实时出字（需要 SAUC WebSocket 流式能力）

### 3.3 关键工程点：浏览器无法在 WebSocket 握手中自定义 Header
- SAUC WebSocket 鉴权要求把密钥放在握手 Header（如 `X-Api-App-Key`、`X-Api-Access-Key`、`X-Api-Resource-Id`、`X-Api-Connect-Id`）
- 浏览器原生 WebSocket API 不支持自定义握手 Header
- 解决：增加本地 Node 代理服务
  - 浏览器连接本地 `ws://localhost:8088/asr`
  - Node 端再连接火山 `wss://openspeech.bytedance.com/...` 并补齐鉴权 Header
  - 双向转发二进制帧（音频与识别结果）

### 3.4 故障排查与修复（403/按钮不可点击）
- 故障 1：上游握手 `403`
  - 根因：把 AUC 的 `x-api-key` 思路用于 SAUC；或资源 ID/权限未开通导致无权限
  - 修复：默认鉴权改为 `X-Api-App-Key + X-Api-Access-Key`；UI 增强提示；代理回传上游响应信息便于定位
- 故障 2：显示“连接正常”但“开始说话”按钮不可点击
  - 根因：执行“测试连接”后未正确恢复按钮状态（缺少 onclose 清理逻辑）
  - 修复：补充 WebSocket `onclose` 回收与 UI 复位，确保按钮可用

## 4. 成果产出（交付物）

### 4.1 可直接试用的前端（实时麦克风流式识别）
- 目录：`前端测试/`
- 文件说明：
  - `index.html`：用户友好操作界面（开始/结束/复制/测试连接/高级设置）
  - `style.css`：界面样式
  - `app.js`：录音、PCM16k 重采样、分包、协议帧构造与解析、实时/最终文本展示、错误提示
  - `server.js`：本地静态服务 + `/asr` WebSocket 代理（补鉴权 Header、转发二进制帧）
  - `package.json` / `package-lock.json`：依赖与启动脚本（`ws`）

## 5. 验证结论

### 5.1 AUC（录音文件识别）验证结论
- submit/query 流程可跑通，能返回完整识别文本

### 5.2 SAUC（实时麦克风流式识别）验证结论
- 使用新的密钥与正确资源配置后，WebSocket 可建立连接
- 点击开始说话可实时显示识别文本，结束后输出最终完整文本

## 6. 使用说明（给试用者）

### 6.1 启动
- 进入目录：`前端测试/`
- 安装依赖（若已安装可跳过）：`npm install`
- 启动服务：`npm run dev`
- 浏览器打开：`http://localhost:8088/`

### 6.2 操作流程
- 鉴权方式选择：优先使用 `X-Api-App-Key + X-Api-Access-Key`
- 选择 `X-Api-Resource-Id`（需与你控制台开通的 SAUC 资源一致）
- 先点“测试连接”确认握手可用
- 点击“开始说话”并允许浏览器麦克风权限
- 说话中实时出字；点击“结束说话”得到最终文本；可点击“复制结果”

### 6.3 常见问题
- `401`：鉴权失败（密钥错误/不匹配）
- `403`：无权限（资源未开通或 Resource-Id 不匹配）
- 无法录音：浏览器/系统未授予麦克风权限（macOS 系统设置与浏览器站点权限）

## 7. 风险与建议（下一阶段）
- 密钥管理：前端输入密钥仅用于本机测试，不应提交到仓库或暴露到公网
- 资源一致性：确保 SAUC 与 AUC 使用的 Resource-Id/鉴权方式区分清晰，避免混用
- 体验优化方向：
  - 增加 VAD/自动停录、音量指示、录音计时
  - 结构化结果（分句、时间戳、说话人）展示与导出
